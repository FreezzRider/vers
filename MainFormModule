
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ДатаПриема 					= '20210901';
	ДатаНачалаНачислений 		= '20210901';
	ДатаОкончанияНачислений 	= '20211231';
	
	Должность = Справочники.Должности.НайтиПоНаименованию("Студент");
	ГрафикРаботы = Справочники.ГрафикиРаботыСотрудников.НайтиПоНаименованию("Стипендия");
	
	НазначатьНачисления 			= Истина;
	НазначатьПрофсоюзныеВзносы 		= Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьВсе(Команда)
	
	Если ОдноПодразделение И Не ЗначениеЗаполнено(Подразделение) Тогда 
		Сообщить("Подразделение не заполнено");
		Возврат;
	КонецЕсли;

	
	ЗагрузитьНаСервере();
	СоздатьДокументыНаСервере();
	
	//ЗагрузитьНаСервереПД();
	//СоздатьДокументыПДНаСервере();
	
	//ЗагрузитьКИНаСервере();
	//ЗаписатьКИНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура Загрузить(Команда)
	Если ОдноПодразделение И Не ЗначениеЗаполнено(Подразделение) Тогда 
		Сообщить("Подразделение не заполнено");
		Возврат;
	КонецЕсли;
	
	ЗагрузитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументы(Команда)
	СоздатьДокументыНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьКИ(Команда)
	ЗаписатьКИНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьКИ(Команда)
	ЗагрузитьКИНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьПД(Команда)
	ЗагрузитьНаСервереПД();
КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументыПД(Команда)
	//СоздатьДокументыПДНаСервере();
КонецПроцедуры


&НаКлиенте
Процедура ПробныйДокументПриИзменении(Элемент)
	ПробныйДокументПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура НачисленияНачислениеПриИзменении(Элемент)
	
	Если СтрНачинаетсяС(Элемент.ТекстРедактирования, "Районный коэффициент") Тогда 
		Элементы.Начисления.ТекущиеДанные.РК = Истина;
		Элементы.Начисления.ТекущиеДанные.Показатель = НайтиПоказатель();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНаСервере()
	ПрочитатьДанные();
КонецПроцедуры

&НаСервере
Процедура ПрочитатьДанные() 
	
	ОбработкаОбъект = РеквизитФормыВЗначение ("Объект");
	
	МакетСтуденты 				= ОбработкаОбъект.ПолучитьМакетОбработки("Студенты");
	тзДанныеСтудентов 			= ПреобразоватьТабличныйДокументВТаблицуЗначений(МакетСтуденты);
	
	Для Каждого Строка Из  тзДанныеСтудентов Цикл 
		
		НоваяСтрока = Данные.Добавить();
		
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
		
		НоваяСтрока.ДатаРождения		= СтроковыеФункцииКлиентСервер.СтрокаВДату(Строка.ДатаРождения);
		НоваяСтрока.Пол					= Перечисления.ПолФизическогоЛица[Строка.Пол];
		
		ФИО = НоваяСтрока.Фамилия + " " + НоваяСтрока.Имя + " " + НоваяСтрока.Отчество;
		
		Если ОдноПодразделение Тогда 
			НоваяСтрока.Подразделение = Подразделение;
		Иначе 
			Если ЗначениеЗаполнено(НоваяСтрока.Группа) Тогда 
				НоваяСтрока.Подразделение = Справочники.ПодразделенияОрганизаций.НайтиПоНаименованию(НоваяСтрока.Группа, Ложь);
			КонецЕсли;		 
		КонецЕсли;
	
		Если ЗначениеЗаполнено(НоваяСтрока.Подразделение) Тогда 
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ШтатноеРасписание.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.ШтатноеРасписание КАК ШтатноеРасписание
			|ГДЕ
			|	ШтатноеРасписание.Подразделение = &Подразделение
			|	И ШтатноеРасписание.Утверждена = ИСТИНА
			|	И ШтатноеРасписание.Должность = &Должность";
			
			Запрос.УстановитьПараметр("Подразделение", НоваяСтрока.Подразделение);
			Запрос.УстановитьПараметр("Должность", 	Должность);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Выборка = РезультатЗапроса.Выбрать();
			
			Выборка1 = РезультатЗапроса.Выгрузить();
			
			Пока Выборка.Следующий() Цикл
				
				НоваяСтрока.Должность = Выборка.Ссылка;
				
			КонецЦикла;
			
		КонецЕсли;
		
		ФизическиеЛицаПоФИОИСНИЛС = ФизическиеЛицаЗарплатаКадры.ФизическиеЛицаПоФИОИСНИЛС(НоваяСтрока.Фамилия, НоваяСтрока.Имя, НоваяСтрока.Отчество, НоваяСтрока.СтраховойНомерПФР); 
		
		Если ФизическиеЛицаПоФИОИСНИЛС.Количество() = 1 Тогда  
		    НоваяСтрока.ФизЛицо = ФизическиеЛицаПоФИОИСНИЛС[0];
			НоваяСтрока.Существует = Истина;
		ИначеЕсли ФизическиеЛицаПоФИОИСНИЛС.Количество() > 1 Тогда   
			Сообщить("Найдено несколько физ лиц - " + ФИО);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТаблицу(ТаблицаДанных, ОписаниеТаблицы, НачальнаяСтрока, КонтрольныйСтолбец)Экспорт
	
	МассивСтолбцов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ОписаниеТаблицы, ",", Истина, Истина);

	Список = Новый ТаблицаЗначений;
	
	Для Каждого ИмяКолонки Из  МассивСтолбцов Цикл
		Список.Колонки.Добавить(ИмяКолонки);
	КонецЦикла;
	
	НомерСтроки = НачальнаяСтрока;
	
	КрутимЦикл = Истина;
	
	Пока КрутимЦикл Цикл
		
		НоваяСтрока = Список.Добавить();
		
		НомерСтолбца = 1;
		
		Для Каждого ИмяКолонки Из  МассивСтолбцов Цикл
			НоваяСтрока[ИмяКолонки] 	= ТаблицаДанных.Область(НомерСтроки, НомерСтолбца, НомерСтроки, НомерСтолбца).Текст;
			НомерСтолбца = НомерСтолбца + 1;	
		КонецЦикла;

		НомерСтроки = НомерСтроки + 1;
		
		КонтрольноеЗначение = ТаблицаДанных.Область(НомерСтроки, КонтрольныйСтолбец, НомерСтроки, КонтрольныйСтолбец).Текст;
		
		КрутимЦикл =  КонтрольноеЗначение <> ""; 
		
	КонецЦикла;
	
	Возврат Список;
	
КонецФункции

&НаСервере
Процедура СоздатьДокументыНаСервере()
	
	ДокументыФЛ = ДокументыФизическихЛиц();
	
	ОбработкаОбъект = РеквизитФормыВЗначение ("Объект");
	
	МакетКонтактнаяИнформация 	= ОбработкаОбъект.ПолучитьМакетОбработки("КонтактнаяИнформация");
	МакетПаспортныеДанные 		= ОбработкаОбъект.ПолучитьМакетОбработки("ПаспортныеДанные");
	
	тзКонтактнаяИнформация 		= ПреобразоватьТабличныйДокументВТаблицуЗначений(МакетКонтактнаяИнформация);
	тзПаспортныеДанные 			= ПреобразоватьТабличныйДокументВТаблицуЗначений(МакетПаспортныеДанные);

	тзКонтактнаяИнформация.Колонки.Добавить("Тип");
	тзКонтактнаяИнформация.Колонки.Добавить("Вид");
	тзКонтактнаяИнформация.Колонки.Добавить("Представление");
	
	Для Каждого СтрокаДанных Из Данные Цикл 
		СоздатьФизЛицоИСотрудника(СтрокаДанных, тзПаспортныеДанные, тзКонтактнаяИнформация);
		СоздатьПриемНаРаботу(СтрокаДанных);
		//Прервать;
	КонецЦикла;
	
	Если НазначатьНачисления Тогда 
		НазначитьНачисления();
	КонецЕсли;

	Если НазначатьПрофсоюзныеВзносы Тогда 
		НазначениеПрофсоюзныхВзносов();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СоздатьФизЛицоИСотрудника(СтрокаДанных, тзПаспортныеДанные, тзКонтактнаяИнформация);
	
	Если Не СтрокаДанных.Существует Тогда 
		НовоеФизЛицо = Справочники.ФизическиеЛица.СоздатьЭлемент();
	Иначе 
		НовоеФизЛицо = СтрокаДанных.ФизЛицо.ПолучитьОбъект();
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(НовоеФизЛицо, СтрокаДанных); 
	ФИО = СтрокаДанных.Фамилия + " " + СтрокаДанных.Имя + " " + СтрокаДанных.Отчество;
	НовоеФизЛицо.ФИО 			= ФИО;
	НовоеФизЛицо.Наименование 	= ФИО;
	
	НовоеФизЛицо.Записать();
	
	СтрокаДанных.ФизЛицо = НовоеФизЛицо.Ссылка;
	
	Набор = РегистрыСведений.ФИОФизическихЛиц.СоздатьНаборЗаписей();
	Набор.Отбор.ФизическоеЛицо.Установить(НовоеФизЛицо.Ссылка);
	Набор.Очистить();
	
	Запись 					= Набор.Добавить();
	Запись.Фамилия			= СтрокаДанных.Фамилия;
	Запись.Имя				= СтрокаДанных.Имя;
	Запись.Отчество			= СтрокаДанных.Отчество;
	Запись.ФизическоеЛицо	= НовоеФизЛицо.Ссылка;
	Запись.Период			= '20210101';
	
	Набор.Записать();
	
	СоздатьЗаписьПаспорныхДанных(НовоеФизЛицо.Ссылка, тзПаспортныеДанные); 
	СоздатьЗаписиКонтактнойИнформации(НовоеФизЛицо.Ссылка, тзКонтактнаяИнформация); 
	
	НовыйСотрудник = Справочники.Сотрудники.СоздатьЭлемент();
	НовыйСотрудник.ФизическоеЛицо = СтрокаДанных.ФизЛицо;
	НовыйСотрудник.Наименование =  ФИО;
	НовыйСотрудник.ГоловнаяОрганизация = Справочники.Организации.НайтиПоНаименованию("ФГБОУ ВО ОрГМУ МИНЗДРАВА РОССИИ");
	
	НовыйСотрудник.Записать();
	
	СтрокаДанных.Сотрудник = НовыйСотрудник.Ссылка;
	
КонецПроцедуры // СоздатьФизЛицо()

&НаСервере
Процедура СоздатьПриемНаРаботу(СтрокаДанных)
	
	НовыйДокументПриема = Документы.ПриемНаРаботу.СоздатьДокумент();
	
	НовыйДокументПриема.Организация = Справочники.Организации.НайтиПоНаименованию("ФГБОУ ВО ОрГМУ МИНЗДРАВА РОССИИ");
	НовыйДокументПриема.ВидДоговора 	=  Перечисления.ВидыДоговоровССотрудниками.ТрудовойДоговор;
	НовыйДокументПриема.Сотрудник 		= СтрокаДанных.Сотрудник;
	НовыйДокументПриема.ФизическоеЛицо = СтрокаДанных.ФизЛицо;
	НовыйДокументПриема.Подразделение 	= СтрокаДанных.Подразделение;
	НовыйДокументПриема.Должность 		= Должность;
	НовыйДокументПриема.КоличествоСтавок = 1;
	НовыйДокументПриема.ДолжностьПоШтатномуРасписанию = СтрокаДанных.Должность;
	НовыйДокументПриема.ДатаПриема 		= ДатаПриема;	
	НовыйДокументПриема.ГрафикРаботы 	= ГрафикРаботы; 
	НовыйДокументПриема.ОтразитьВТрудовойКнижке = Ложь;	
	НовыйДокументПриема.Дата 			= ДатаПриема;
	НовыйДокументПриема.ВидЗанятости = Перечисления.ВидыЗанятости.ОсновноеМестоРаботы;
	НовыйДокументПриема.СпособРасчетаАванса = Перечисления.СпособыРасчетаАванса.РасчетомЗаПервуюПоловинуМесяца;
	НовыйДокументПриема.Руководитель = Справочники.ФизическиеЛица.НайтиПоНаименованию("Мирошниченко Игорь Васильевич", Истина);
	НовыйДокументПриема.ДолжностьРуководителя = Справочники.Должности.НайтиПоНаименованию("Ректор", Истина);
	
	//НоваяСтрокаНачислений = НовыйДокументПриема.Начисления.Добавить();
	//
	//НоваяСтрокаНачислений.Начисление 						= ПланыВидовРасчета.Начисления.НайтиПоНаименованию("Районный коэффициент ст", Истина);
	//НоваяСтрокаНачислений.Размер 							= 0;
	//НоваяСтрокаНачислений.ИдентификаторСтрокиВидаРасчета 	= 1;
	//
	//НоваяСтрокаПоказатели = НовыйДокументПриема.Показатели.Добавить();
	//
	//НоваяСтрокаПоказатели.Показатель 						= Справочники.ПоказателиРасчетаЗарплаты.НайтиПоНаименованию("Процент Районный коэффициент ст", Истина);
	//НоваяСтрокаПоказатели.Значение							= 15;
	//НоваяСтрокаПоказатели.ИдентификаторСтрокиВидаРасчета 	= 1;
	//
	//НовыйДокументПриема.НачисленияУтверждены = Истина;
	
	НовыйДокументПриема.Комментарий = "Сформирован автоматически " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
	
	НовыйДокументПриема.Записать(РежимЗаписиДокумента.Запись);
	НовыйДокументПриема.Записать(РежимЗаписиДокумента.Проведение);
	
	
КонецПроцедуры // СоздатьПриемНаРаботу()

&НаСервере
Процедура НазначитьНачисления()
	
	Для Каждого СтрокаНачислений Из Начисления Цикл 
		
		НовыйДокумент = Документы.НазначениеПлановогоНачисления.СоздатьДокумент();
		НовыйДокумент.Организация = Справочники.Организации.НайтиПоНаименованию("ФГБОУ ВО ОрГМУ МИНЗДРАВА РОССИИ");
		
		НовыйДокумент.Дата 			= ДатаПриема;
		НовыйДокумент.ДатаНазначения 	= ДатаНачалаНачислений;
		НовыйДокумент.ДатаОкончания  	= ДатаОкончанияНачислений;
		
		НовыйДокумент.Начисление       = СтрокаНачислений.Начисление;
		
		НовыйДокумент.Комментарий = "Сформирован автоматически " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
		
		ИдентификаторСтрокиСотрудника = 1;
		
		Для Каждого СтрокаДанных Из Данные Цикл 
			
			НовыйДокументСотрудник = НовыйДокумент.Сотрудники.Добавить();
			НовыйДокументСотрудник.Сотрудник 						= СтрокаДанных.Сотрудник;
			НовыйДокументСотрудник.ДатаНазначения 					= ДатаНачалаНачислений;
			НовыйДокументСотрудник.ДатаОкончания 					= ДатаОкончанияНачислений;
			НовыйДокументСотрудник.ИдентификаторСтрокиСотрудника  	= ИдентификаторСтрокиСотрудника;
			
			НовыйДокументФизЛицо = НовыйДокумент.ФизическиеЛица.Добавить();
			НовыйДокументФизЛицо.ФизическоеЛицо = СтрокаДанных.ФизЛицо;
			
			Если ЗначениеЗаполнено(СтрокаНачислений.Показатель) Тогда 
				НовыйДокументПоказатели = НовыйДокумент.ПоказателиСотрудников.Добавить();
				НовыйДокументПоказатели.Показатель 						= СтрокаНачислений.Показатель;
				НовыйДокументПоказатели.Значение 						= СтрокаНачислений.Значение;
				НовыйДокументПоказатели.ИдентификаторСтрокиСотрудника  	= ИдентификаторСтрокиСотрудника;
			КонецЕсли;
		
			ИдентификаторСтрокиСотрудника = ИдентификаторСтрокиСотрудника +1;
			
		КонецЦикла;
		
		НовыйДокумент.Записать(РежимЗаписиДокумента.Запись);
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура НазначениеПрофсоюзныхВзносов()
	
	НовыйДокумент = Документы.УдержаниеПрофсоюзныхВзносов.СоздатьДокумент();
	НовыйДокумент.Организация = Справочники.Организации.НайтиПоНаименованию("ФГБОУ ВО ОрГМУ МИНЗДРАВА РОССИИ");
	
	НовыйДокумент.Дата 				= ДатаПриема;
	НовыйДокумент.ДатаНачала	 	= ДатаПриема;
	НовыйДокумент.Действие 			= Перечисления.ДействияСУдержаниями.Начать;
	НовыйДокумент.ПрофсоюзнаяОрганизация = Справочники.Контрагенты.НайтиПоНаименованию("Контрагент", Истина);
				  
	НовыйДокумент.Удержание       = ПланыВидовРасчета.Удержания.НайтиПоНаименованию("Профвзносы", Истина);
	
	НовыйДокумент.Комментарий = "Сформирован автоматически " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
	
	ИдентификаторСтрокиВидаРасчета = 1;
	
	Для Каждого СтрокаДанных Из Данные Цикл 
		
		НовыйДокументСотрудник = НовыйДокумент.Удержания.Добавить();
		
		НовыйДокументСотрудник.РабочееМесто 			= СтрокаДанных.Сотрудник;
		
		НовыйДокументСотрудник.ФизическоеЛицо 			= СтрокаДанных.ФизЛицо;
		НовыйДокументСотрудник.ИдентификаторСтрокиВидаРасчета  = ИдентификаторСтрокиВидаРасчета;
		
		НовыйДокументПоказатели = НовыйДокумент.Показатели.Добавить();
		
		НовыйДокументПоказатели.Показатель = Справочники.ПоказателиРасчетаЗарплаты.НайтиПоНаименованию("Процент Профвзносы", Истина);
		НовыйДокументПоказатели.Значение = 1;
		НовыйДокументПоказатели.ИдентификаторСтрокиВидаРасчета  = ИдентификаторСтрокиВидаРасчета;
		
		ИдентификаторСтрокиВидаРасчета = ИдентификаторСтрокиВидаРасчета +1;
		
	КонецЦикла;
	
	НовыйДокумент.Записать(РежимЗаписиДокумента.Запись);

	
КонецПроцедуры

&НаСервере
Процедура ПробныйДокументПриИзмененииНаСервере()
	ДокументОбъект = ПробныйДокумент.ПолучитьОбъект();
КонецПроцедуры

&НаСервере
Функция НайтиПоказатель()
	
	Возврат Справочники.ПоказателиРасчетаЗарплаты.НайтиПоНаименованию("Процент Районный коэффициент ст", Истина);
	
КонецФункции 

&НаСервере
Процедура ЗагрузитьНаСервереПД()
	ПрочитатьДанныеПД();
КонецПроцедуры // ЗагрузитьНаСервереПД()

&НаСервере
Процедура ПрочитатьДанныеПД()

	//ДокументыФЛ = ДокументыФизическихЛиц();

	//ОбработкаОбъект = РеквизитФормыВЗначение ("Объект");
	//
	//Макет = ОбработкаОбъект.ПолучитьМакетОбработки("ПаспортныеДанные");
	//
	//ДанныеТаблицы = ПреобразоватьТабличныйДокументВТаблицуЗначений(Макет);	
	//
	//Для Каждого Строка Из  ДанныеТаблицы Цикл 
	//	
	//	Запрос = Новый Запрос;
	//	Запрос.Текст = 
	//	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	//	|	ФизическиеЛица.Ссылка КАК ФизЛицо
	//	|ИЗ
	//	|	Справочник.ФизическиеЛица КАК ФизическиеЛица
	//	|ГДЕ
	//	|	ФизическиеЛица.СтраховойНомерПФР = &СтраховойНомерПФР";
	//	
	//	Запрос.УстановитьПараметр("СтраховойНомерПФР", 	Строка.СтраховойНомерПФР);
	//	
	//	РезультатЗапроса = Запрос.Выполнить();
	//	
	//	Выборка = РезультатЗапроса.Выгрузить();
	//	
	//	Если Отладка Тогда 
	//		КрутитьЦикл = Истина;
	//	Иначе 
	//		КрутитьЦикл = Выборка.Количество() = 1
	//	КонецЕсли;
	//	
	//	Если КрутитьЦикл Тогда 
	//		
	//		НоваяСтрока = ПаспортныеДанные.Добавить();
	//		
	//		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
	//		
	//		Попытка
	//			НоваяСтрока.ФизЛицо 			= Выборка[0].ФизЛицо;
	//		Исключение
	//		КонецПопытки;
	//		
	//		НоваяСтрока.ВидДокумента		=  ДокументыФЛ.Получить(Строка.ВидДокумента);
	//			
	//		Если НоваяСтрока.ВидДокумента = Справочники.ВидыДокументовФизическихЛиц.ПаспортРФ Тогда   
	//			НоваяСтрока.Серия = Лев(Строка.Серия, 2) + " " + Прав(Строка.Серия, 2);
	//		КонецЕсли;

	//		НоваяСтрока.ДатаВыдачи 			= СтроковыеФункцииКлиентСервер.СтрокаВДату(Строка.ДатаВыдачи);
	//		НоваяСтрока.ДатаРождения 		= СтроковыеФункцииКлиентСервер.СтрокаВДату(Строка.ДатаРождения);

	//		Если Строка.СрокДействия <> "" Тогда   
	//			НоваяСтрока.СрокДействия = СтроковыеФункцииКлиентСервер.СтрокаВДату(Строка.СрокДействия);
	//		КонецЕсли;
	//		
	//	КонецЕсли;
	//	
	//КонецЦикла;

КонецПроцедуры // ПрочитатьДанныеПД()

Функция ДокументыФизическихЛиц()
	
	ДокументыФЛ  = Новый Соответствие;
	
	ДокументыФЛ.Вставить("Паспорт гражданина РФ", 			Справочники.ВидыДокументовФизическихЛиц.ПаспортРФ);
	ДокументыФЛ.Вставить("Паспорт иностранного гражданина", Справочники.ВидыДокументовФизическихЛиц.НайтиПоНаименованию("Иностранный паспорт", Истина));
	
	Возврат ДокументыФЛ;
	
КонецФункции

Процедура СоздатьЗаписьПаспорныхДанных(ФизическоеЛицо, тзПаспортныеДанные)
	
	ДокументыФЛ = ДокументыФизическихЛиц();
	
	Отбор = Новый Структура("СтраховойНомерПФР", ФизическоеЛицо.СтраховойНомерПФР);
	
	СтрокиДанных = тзПаспортныеДанные.НайтиСтроки(Отбор);

	Если СтрокиДанных.Количество() = 1 Тогда  
		
		СтрокаДанных = СтрокиДанных[0];
		
		Попытка
			
			Набор = РегистрыСведений.ДокументыФизическихЛиц.СоздатьНаборЗаписей();
			
			Набор.Отбор.Физлицо.Установить(ФизическоеЛицо);
			
				Запись 											= Набор.Добавить();
				ЗаполнитьЗначенияСвойств(Запись, СтрокаДанных);
				Запись.ВидДокумента								=  ДокументыФЛ.Получить(СтрокаДанных.ВидДокумента);
				
				Если Запись.ВидДокумента = Справочники.ВидыДокументовФизическихЛиц.ПаспортРФ Тогда   
					Запись.Серия 								= Лев(СтрокаДанных.Серия, 2) + " " + Прав(СтрокаДанных.Серия, 2);
				КонецЕсли;

				Запись.ДатаВыдачи 								= СтроковыеФункцииКлиентСервер.СтрокаВДату(СтрокаДанных.ДатаВыдачи);
				Запись.Период 									= Запись.ДатаВыдачи;
				Запись.ЯвляетсяДокументомУдостоверяющимЛичность = Истина; 
				Запись.Представление 							= РегистрыСведений.ДокументыФизическихЛиц.ПредставлениеЗаписи(Запись); 
				Запись.Физлицо		 							= ФизическоеЛицо; 
				Если СтрокаДанных.СрокДействия <> "" Тогда
					Запись.СрокДействия							= СтроковыеФункцииКлиентСервер.СтрокаВДату(СтрокаДанных.СрокДействия);
				КонецЕсли;
			Набор.Записать();
		Исключение
			
		КонецПопытки;

	КонецЕсли;
	
КонецПроцедуры

Процедура СоздатьЗаписиКонтактнойИнформации(ФизическоеЛицо, тзКонтактнаяИнформация)
	
	
	Отбор = Новый Структура("СтраховойНомерПФР", ФизическоеЛицо.СтраховойНомерПФР);
	
	КонтактнаяИнформацияФизЛица  = тзКонтактнаяИнформация.НайтиСтроки(Отбор);
	
	Если КонтактнаяИнформацияФизЛица.Количество() > 0 Тогда  
		
		ФизЛицоОбъект = ФизическоеЛицо.ПолучитьОбъект();
		
		КИФизЛица = ФизЛицоОбъект.КонтактнаяИнформация;
		
		КИФизЛица.Очистить();
		
	КонецЕсли;
	
	Для Каждого Контакт Из КонтактнаяИнформацияФизЛица Цикл 
		
			Если Контакт.ТипКонтакта = "Адрес по прописке физического лица" Тогда

				Контакт.Тип		= Перечисления.ТипыКонтактнойИнформации.Адрес;
				Контакт.Вид		= Справочники.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица;
				
			ИначеЕсли Контакт.ТипКонтакта = "Адрес проживания физического лица" Тогда
				
				Контакт.Тип		= Перечисления.ТипыКонтактнойИнформации.Адрес;
				Контакт.Вид		= Справочники.ВидыКонтактнойИнформации.АдресМестаПроживанияФизическиеЛица;
				
			ИначеЕсли Контакт.ТипКонтакта = "Адрес электронной почты" Тогда 
				
				Контакт.Тип		= Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты;
				Контакт.Вид		= Справочники.ВидыКонтактнойИнформации.EMailФизическиеЛица;
				
			ИначеЕсли Контакт.ТипКонтакта = "Телефон" Тогда 
				
				Контакт.Тип		= Перечисления.ТипыКонтактнойИнформации.Телефон;
				Контакт.Вид		= Справочники.ВидыКонтактнойИнформации.ТелефонМобильныйФизическиеЛица;
				
			КонецЕсли;
			
			Если Контакт.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес Тогда  
				Контакт.Представление		= СформироватьПредставлениеАдреса(Контакт);
			КонецЕсли;
		
			Если Контакт.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес Тогда  
				ЗаписатьАдрес(КИФизЛица, Контакт);	
			ИначеЕсли Контакт.Тип = Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты Тогда  
				ЗаписатьАдресЭлектроннойПочты(КИФизЛица, Контакт);
			ИначеЕсли Контакт.Тип = Перечисления.ТипыКонтактнойИнформации.Телефон Тогда  
				ЗаписатьТелефон(КИФизЛица, Контакт);
			КонецЕсли;
			
			ФизЛицоОбъект.Записать();
		
	КонецЦикла;
	
КонецПроцедуры





&НаСервере
Процедура УдалитьСоздатьДокументыПДНаСервере()
	
	Для Каждого СтрокаДанных Из ПаспортныеДанные Цикл 
		
		Попытка
			
			Набор = РегистрыСведений.ДокументыФизическихЛиц.СоздатьНаборЗаписей();
			Набор.Отбор.Физлицо.Установить(СтрокаДанных.ФизЛицо);
			
			Запись = Набор.Добавить();
			
			ЗаполнитьЗначенияСвойств(Запись, СтрокаДанных);
			
			Запись.Период = СтрокаДанных.ДатаВыдачи;
			
			Запись.ЯвляетсяДокументомУдостоверяющимЛичность = Истина; 
			
			Запись.Представление = РегистрыСведений.ДокументыФизическихЛиц.ПредставлениеЗаписи(Запись); 
			
			Набор.Записать();
			
		Исключение
			
		КонецПопытки;
		
		
	КонецЦикла;
	
КонецПроцедуры

//1.	Фамилия	
//2.	Имя	
//3.	Отчество	
//4.	СНИЛС	
//5.	ДатаРождения	
//6.	ТипАдреса	
//7.	ЗначенияПолей	
//8.	Квартира	
//9.	Корпус	
//10.	Дом	
//11.	Улица	
//12.	НаселенныйПункт	
//13.	Город	
//14.	Район	
//15.	Регион	
//16.	СтранаКодАльфа3	
//17.	СтранаКодАльфа2	
//18.	СтранаНаименованиеПолное	
//19.	Индекс	
//20.	ПредставлениеАдреса	
&НаСервере
Процедура ЗагрузитьКИНаСервере()
	
	Отбор = Новый Структура("Существует", Ложь);
	
	ОбработкаОбъект = РеквизитФормыВЗначение ("Объект");
	
	Макет = ОбработкаОбъект.ПолучитьМакетОбработки("КонтактнаяИнформация");
	
	ДанныеТаблицы = ПреобразоватьТабличныйДокументВТаблицуЗначений(Макет);	

	Для Каждого Строка Из  ДанныеТаблицы Цикл 
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ФизическиеЛица.Ссылка КАК ФизЛицо
		|ИЗ
		|	Справочник.ФизическиеЛица КАК ФизическиеЛица
		|ГДЕ
		|	ФизическиеЛица.СтраховойНомерПФР = &СтраховойНомерПФР";
		
		Запрос.УстановитьПараметр("СтраховойНомерПФР", 	Строка.СтраховойНомерПФР);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Выборка = РезультатЗапроса.Выгрузить();
		
		Если Отладка Тогда 
			КрутитьЦикл = Истина;
		Иначе 
			КрутитьЦикл = Выборка.Количество() = 1
		КонецЕсли;
		
		Если КрутитьЦикл Тогда 
			
			НоваяСтрока = КонтактнаяИнформация.Добавить();
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);

			Попытка
				НоваяСтрока.ФизЛицо 			= Выборка[0].ФизЛицо;
			Исключение
			КонецПопытки;
		
			НоваяСтрока.ДатаРождения 		= СтроковыеФункцииКлиентСервер.СтрокаВДату(СокрЛП(Строка.ДатаРождения));
			
			Если Строка.ТипКонтакта = "Адрес по прописке физического лица" Тогда

				НоваяСтрока.Тип		= Перечисления.ТипыКонтактнойИнформации.Адрес;
				НоваяСтрока.Вид		= Справочники.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица;
				
			ИначеЕсли Строка.ТипКонтакта = "Адрес проживания физического лица" Тогда
				
				НоваяСтрока.Тип		= Перечисления.ТипыКонтактнойИнформации.Адрес;
				НоваяСтрока.Вид		= Справочники.ВидыКонтактнойИнформации.АдресМестаПроживанияФизическиеЛица;
				
			ИначеЕсли Строка.ТипКонтакта = "Адрес электронной почты" Тогда 
				
				НоваяСтрока.Тип		= Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты;
				НоваяСтрока.Вид		= Справочники.ВидыКонтактнойИнформации.EMailФизическиеЛица;
				
			ИначеЕсли Строка.ТипКонтакта = "Телефон" Тогда 
				
				НоваяСтрока.Тип		= Перечисления.ТипыКонтактнойИнформации.Телефон;
				НоваяСтрока.Вид		= Справочники.ВидыКонтактнойИнформации.ТелефонМобильныйФизическиеЛица;
				
			КонецЕсли;
			
			Если НоваяСтрока.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес Тогда  
				НоваяСтрока.Представление		= СформироватьПредставлениеАдреса(НоваяСтрока);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;

	
КонецПроцедуры

&НаСервере
Функция ПолучитьДанныеЯчейкиМакета(Макет, НомерСтроки, НомерСтолбца)
	
	Возврат СокрЛП(Макет.Область(НомерСтроки, НомерСтолбца, НомерСтроки, НомерСтолбца).Текст);
	
КонецФункции

&НаСервере
Процедура ЗаписатьКИНаСервере()
	
	ФизЛица = КонтактнаяИнформация.Выгрузить();
	
	ФизЛица.Свернуть("ФизЛицо");
	
	Для Каждого СтрокаТаблицы Из ФизЛица Цикл
		
		Если СтрокаТаблицы.ФизЛицо = Справочники.ФизическиеЛица.ПустаяСсылка() Тогда 
			Продолжить;
		КонецЕсли;
			
		Отбор = Новый Структура;
		
		Отбор.Вставить("ФизЛицо", СтрокаТаблицы.ФизЛицо);
		
		КонтактнаяИнформацияФизЛица  = КонтактнаяИнформация.НайтиСтроки(Отбор);
		
		Если КонтактнаяИнформацияФизЛица.Количество() > 0 Тогда  
			
			ФизЛицоОбъект = КонтактнаяИнформацияФизЛица[0].ФизЛицо.ПолучитьОбъект();
		
			КИФизЛица = ФизЛицоОбъект.КонтактнаяИнформация;
				
			КИФизЛица.Очистить();
			
		КонецЕсли;
	
		Для Каждого ДанныеФизЛица Из КонтактнаяИнформацияФизЛица Цикл 
			
			
			Если ДанныеФизЛица.Тип = Перечисления.ТипыКонтактнойИнформации.Адрес Тогда  
				ЗаписатьАдрес(КИФизЛица, ДанныеФизЛица);	
			ИначеЕсли ДанныеФизЛица.Тип = Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты Тогда  
				ЗаписатьАдресЭлектроннойПочты(КИФизЛица, ДанныеФизЛица);
			ИначеЕсли ДанныеФизЛица.Тип = Перечисления.ТипыКонтактнойИнформации.Телефон Тогда  
				ЗаписатьТелефон(КИФизЛица, ДанныеФизЛица);
			КонецЕсли;
			
			ФизЛицоОбъект.Записать();
			
		КонецЦикла;
	
		//Прервать;
		
	КонецЦикла;

	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьТелефон(КИФизЛица, ДанныеАдреса)
	
	НоваяЗапись = КИФизЛица.Добавить();
	
	ЗаполнитьЗначенияСвойств(НоваяЗапись, ДанныеАдреса);
	
	НоваяЗапись.ВидДляСписка = НоваяЗапись.Вид;

	Адрес = УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияПоПредставлению(ДанныеАдреса.ПредставлениеАдреса, Перечисления.ТипыКонтактнойИнформации.Телефон, Истина);
	
	//Адрес.Value = ДанныеАдреса.ПредставлениеАдреса; 
	
	НоваяЗапись.Значение 		= УправлениеКонтактнойИнформациейСлужебный.СтруктураВСтрокуJSON(Адрес);
	НоваяЗапись.ЗначенияПолей 	= УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияИзJSONВXML(Адрес, Перечисления.ТипыКонтактнойИнформации.Адрес);
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьАдресЭлектроннойПочты(КИФизЛица, ДанныеАдреса)
	
	НоваяЗапись = КИФизЛица.Добавить();
	
	ЗаполнитьЗначенияСвойств(НоваяЗапись, ДанныеАдреса);
	
	НоваяЗапись.ВидДляСписка = НоваяЗапись.Вид;

	Адрес = УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияПоПредставлению(ДанныеАдреса.ПредставлениеАдреса, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Истина);
	
	Адрес.Value = ДанныеАдреса.ПредставлениеАдреса; 
	
	НоваяЗапись.Значение 		= УправлениеКонтактнойИнформациейСлужебный.СтруктураВСтрокуJSON(Адрес);
	НоваяЗапись.ЗначенияПолей 	= УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияИзJSONВXML(Адрес, Перечисления.ТипыКонтактнойИнформации.Адрес);
	
КонецПроцедуры



&НаСервере
Процедура ЗаписатьАдрес(КИФизЛица, ДанныеАдреса)
	
	НоваяЗапись = КИФизЛица.Добавить();
	
	ЗаполнитьЗначенияСвойств(НоваяЗапись, ДанныеАдреса);
	
	НоваяЗапись.ВидДляСписка = НоваяЗапись.Вид;
	
	Адрес = УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияПоПредставлению(ДанныеАдреса.Представление, Перечисления.ТипыКонтактнойИнформации.Адрес, Истина);
	
	Адрес.addressType = "Административно-территориальный";
	
	РаботаСАдресамиКлиентСервер.ОбновитьПредставлениеАдреса(Адрес, Ложь);
	ПредставлениеАдреса = Адрес.Value;

//	
//	Результат = УправлениеКонтактнойИнформациейСлужебный.ПроверитьАдрес(Адрес);
//	
//	Адрес2 = УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияПоПредставлению(ДанныеАдреса.Представление, Перечисления.ТипыКонтактнойИнформации.Адрес, Ложь);
	
	//КонтактнаяИнформацияXDTO 		= УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияXDTOПоПредставлению(ДанныеАдреса.Представление, Перечисления.ТипыКонтактнойИнформации.Адрес);
	НоваяЗапись.Значение 		= УправлениеКонтактнойИнформациейСлужебный.СтруктураВСтрокуJSON(Адрес);
	НоваяЗапись.ЗначенияПолей 	= УправлениеКонтактнойИнформациейСлужебный.КонтактнаяИнформацияИзJSONВXML(Адрес, Перечисления.ТипыКонтактнойИнформации.Адрес);
	НоваяЗапись.Представление	= Адрес.Value;
	
	
	
КонецПроцедуры

&НаСервере
Функция СформироватьПредставлениеАдреса(НоваяСтрока)
	
	Представление = "РОССИЯ, " + НоваяСтрока.Индекс;
	
	Если ЗначениеЗаполнено(НоваяСтрока.Город) Тогда 
		
		//Представление = Представление + ", " + НоваяСтрока.Регион;
		Представление = Представление + ", " + НоваяСтрока.Город;
		
		Если ЗначениеЗаполнено(НоваяСтрока.НаселенныйПункт) Тогда 
			
			Представление = Представление + ", " + НоваяСтрока.НаселенныйПункт;
			
		КонецЕсли;
		
	Иначе 
		
		Представление = Представление + ", " + НоваяСтрока.Регион + ", " + НоваяСтрока.Район + ", " + НоваяСтрока.НаселенныйПункт;
		
	КонецЕсли;
	
	Представление = Представление + ", " + НоваяСтрока.Улица  + ", дом " + НоваяСтрока.Дом;
	
	Если ЗначениеЗаполнено(НоваяСтрока.Корпус) Тогда 
		
		Представление = Представление + "/" + НоваяСтрока.Корпус;
	
	КонецЕсли;
	
	Если ЗначениеЗаполнено(НоваяСтрока.Квартира) Тогда 
		
		Представление = Представление + ", квартира " + НоваяСтрока.Квартира;
	
	КонецЕсли;
	
	Возврат Представление;
	
КонецФункции

&НаСервере
Процедура ФизическоеЛицоПриИзмененииНаСервере()
	
	ФЛ = ФизическоеЛицо.ПолучитьОбъект();
	
	КИ = ФЛ.КонтактнаяИнформация;
	
КонецПроцедуры

&НаКлиенте
Процедура ФизическоеЛицоПриИзменении(Элемент)
	ФизическоеЛицоПриИзмененииНаСервере();
КонецПроцедуры


&НаСервере
Функция ПреобразоватьТабличныйДокументВТаблицуЗначений(ТабДокумент) 
	
	ПоследняяСтрока = ТабДокумент.ВысотаТаблицы;
	ПоследняяКолонка = ТабДокумент.ШиринаТаблицы;
	ОбластьЯчеек = ТабДокумент.Область(1, 1, ПоследняяСтрока, ПоследняяКолонка); 
	// Создаем описание источника данных на основании области ячеек табличного документа.
	ИсточникДанных = Новый ОписаниеИсточникаДанных(ОбластьЯчеек);  
	// Создаем объект для интеллектуального построения отчетов,
	// указываем источник данных и выполняем построение отчета.
	ПостроительОтчета = Новый ПостроительОтчета; 
	ПостроительОтчета.ИсточникДанных = ИсточникДанных;
	ПостроительОтчета.Выполнить();
	// Результат выгружаем в таблицу значений.
	ТабЗначений = ПостроительОтчета.Результат.Выгрузить();
	
	Возврат ТабЗначений
	
КонецФункции

